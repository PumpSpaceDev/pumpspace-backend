# PumpSpace 完整技术架构设计（详细版）

## 总体架构概述

PumpSpace 采用 **微服务架构**，各模块独立运行，结合 Redis Pub/Sub 作为内部通信机制，实现高效的数据分发和实时处理。同时，通过 PostgreSQL 实现长时间数据存储，确保信号评估与分析的可追溯性。

---

## 核心模块划分

### 1. 数据收集服务（Data Collector Service）

**职责**：
- 从 Shyft 提供的 gRPC 服务中接收所有 Solana 交易流。
- 筛选出 Raydium 相关的交易：
  - 存储：将所有过滤后的 Raydium 交易写入数据库。
  - 发布：将 Raydium 交易通过 Redis Pub/Sub 推送到下游服务。

**输入**：
- Solana 全量交易流（通过 gRPC）。

**输出**：
- **数据库**：存储所有 Raydium 相关交易。
- **Redis Pub/Sub**：推送全量 Raydium 交易。

---

### 2. 聪明钱评估模块（Smart Money Evaluation Module）

**职责**：
- 管理初始的聪明钱地址库（第三方提供，如 10 万个地址）。
- 定时分析这些地址的历史交易表现，计算盈利能力和分数。
- 筛选出高分的“高级聪明钱”地址，作为实时匹配的目标。

**输入**：
- 初始聪明钱地址库（数据库中存储）。
- 历史交易数据（数据库中存储的全量 Raydium 交易）。

**输出**：
- **数据库**：存储筛选后的高级聪明钱地址列表，供实时匹配使用。

---

### 3. 分析与统计服务（Analysis and Token Statistics Service）

**职责**：
- **聪明钱匹配**：
  - 从 Redis Pub/Sub 订阅全量 Raydium 交易。
  - 识别是否为高级聪明钱地址的交易，并将匹配结果推送至通知服务。
- **Token 统计**：
  - 实时计算所有 Token 的涨跌幅和交易量：
    - 时间窗口：5 分钟、60 分钟、24 小时等。
  - 使用分桶存储和滑动窗口算法维护 Token 的实时统计。
  - 将实时统计数据存储在 Redis 中，并对不活跃 Token 自动过期。
  - 当 Token 过期后重新激活时，从数据库加载分桶存储数据恢复统计。

**输入**：
- Redis Pub/Sub 中的全量 Raydium 交易。

**输出**：
- **Redis**：
  - 存储实时 Token 统计数据（分桶存储）。
  - 推送聪明钱匹配结果。
- **数据库**：
  - 存储 Redis 分桶数据的备份（定期或主动删除时持久化）。

---

### 4. 通知服务（Notification Service）

**职责**：
- 从 Redis Pub/Sub 订阅聪明钱匹配结果。
- 应用高级规则（如连续购买、评分阈值等）进一步过滤结果。
- 将符合规则的推送内容发送给用户（如通过 Telegram Bot）。

**输入**：
- Redis Pub/Sub 中的聪明钱匹配结果。

**输出**：
- 用户推送通知。

---

### 5. 信号记录服务（Signal Recorder Service）

**职责**：
- 采集并存储外部信号（如 Telegram Channel 推荐的 Token）。
- 存储信号与推荐时间的关联记录。

**输入**：
- 外部信号源（Telegram Channel）。

**输出**：
- **数据库**：信号推荐历史记录。

---

### 6. 信号分析服务（Signal Analyzer Service）

**职责**：
- 离线分析信号的历史表现（结合数据库中的完整交易历史）。
- 生成信号质量评估报告（如推荐 Token 的收益率、成功率）。

**输入**：
- 数据库中的信号历史记录与交易历史数据。

**输出**：
- **数据库**：信号分析结果。

---

### 7. 前端服务（Frontend Service）

**职责**：
- 提供 Web 前端和 Telegram 前端的 API 接口。
- 展示以下内容：
  - Token 统计数据（涨跌幅、交易量）。
  - 聪明钱匹配推送。
  - 信号分析结果。

**输入**：
- 调用 Redis 和数据库的数据接口。

**输出**：
- 前端可视化展示。

---

## 存储设计

### 1. 数据库（PostgreSQL）

**存储内容**：
- 原始交易数据（至少 1 个月）。
- 聪明钱地址库与评估结果。
- 信号历史记录与分析结果。
- Redis 分桶数据备份（用于过期数据的恢复）。

**表设计**：
- **交易表**：存储 Raydium 交易数据。
- **分桶数据表**：存储 Redis 分桶的持久化备份。
- **信号表**：记录信号来源和推荐的 Token。

### 2. Redis

**存储内容**：
- 实时 Token 统计数据（分桶存储）。
- 聪明钱匹配结果（通过 Pub/Sub 推送）。

**数据过期**：
- 设置 TTL 以自动清理不活跃的 Token。

---

## 关键流程优化

1. **聪明钱地址的评估和匹配**：
   - 定期分析评估地址盈利能力，动态更新高级聪明钱列表。
   - 实时从 Redis 中匹配聪明钱交易，确保高效推送。

2. **Token 统计优化**：
   - 滑动窗口 + 分桶存储：支持高并发低内存占用。
   - Redis + 数据库双层存储：既保证实时性，又支持长期备份。

3. **服务间通信优化**：
   - 使用 Redis Pub/Sub 实现实时高效的数据分发。
   - 将通知服务独立，避免重复订阅 Redis 流。

---

## 总结

这套架构在模块职责、实时性能和数据可靠性方面达到了平衡，并通过 Redis 和数据库的双层存储有效管理高并发场景。

如果还有遗漏或需要调整的细节，欢迎继续讨论！😊
